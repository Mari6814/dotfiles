# Mark this as loaded
export BASH_ALIASES="$HOME/.bash_aliases"
case $- in *i*) echo "bash_aliases: $BASH_ALIASES" >&2;; esac

# easy back cd command
alias ..="cd .."
# Virtaul env auto
function cd {
    builtin cd $1
    if [ -z "$VIRTUAL_ENV" ]; then
        if [ -f ./venv/bin/activate ]; then
            . ./venv/bin/activate
        fi
    else
        local CURRENT="$(realpath $(pwd))"
        local ROOT="$(realpath $VIRTUAL_ENV/..)"
        case $CURRENT/ in
            $ROOT/*) ;; # Still inside venv
            *) deactivate;; # Not in venv hierarchy anymore
        esac
    fi
}

# Create a virtual folder out of a glob
function mkvdir {
    USAGE="usage:  <dirname> FILE [FILES ...]"
    if [ -z "$1" ]; then
        echo $USAGE >&2
        return 1
    fi
    if [ -z "$2" ]; then
        echo "err: Missing glob output as argument 2.." >&2
        return 1
    fi
    mkdir "$1"
    for path in $@; do
        ln -vs "$path" "$1/$(basename $path)"
    done
}

function ports-in-use {
    lsof -i tcp -s tcp:listen | awk '$8 == "TCP" { split($9,a,":"); print a[2] }'
}
function forward-open-ports {
    if [ -z $1 ]; then
        echo err: Missing hostname >&2
        return 1
    fi
    local REMOTE_COMMAND="$(declare -f ports-in-use); ports-in-use"
    local PORTS="$(ssh -T $1 "$REMOTE_COMMAND")"
    for PORT in $PORTS; do
        echo http://localhost:$PORT
        ssh -NfL "$PORT:localhost:$PORT" "$1"
    done
}
function forward-port {
    if [ -z $1 ]; then
        echo err: Missing hostname:port >&2
        return 1
    fi
    local HOST=$(echo $1 | awk '{ split($1,a,":"); print a[1] }')
    local PORT=$(echo $1 | awk '{ split($1,a,":"); print a[2] }')
    ssh -NL "${PORT:-$2}:localhost:$PORT" "$HOST"
}
# General aliases
function e {
    "$EDITOR" "$@"
}
# Edit bashrc
alias ebash="e ~/.bashrc && source ~/.bashrc"
# Edit profile
alias eprofile="e ~/.profile && source ~/.profile"
# Edit vim config
alias evim="e ~/.vimrc"
# Edit nvim config
alias envim="e ~/.config/nvim/init.vim"
# Edit bash aliases
alias ealias="e ~/.bash_aliases && source ~/.bash_aliases"
# keep tailing a file
alias follow="tail -f"
# Google something
alias g="googler --count 3"
# Search for a pattern in any file from the current cwd
alias contains="grep -rnw . -e"
# Youtube dl
alias youtube-mp3="youtube-dl --extract-audio --audio-format mp3"
# shortcut for nvidia-smi
alias smi=nvidia-smi

# Git shortcuts
alias gs="git status"
alias gp="git push"
alias gcam="git commit -am"

# Create executable bash script and edit it
function cmd {
    NAME="${1:?'Usage: cmd <cmdname>'}"
    [ -e $NAME ] && echo "Command already exists: $NAME" && return 1
    echo "Creating command: $NAME"
    echo '#!/bin/bash' >> "$NAME"
    e "$NAME"
    chmod +x "$NAME"
}

# Start recording the history and add it to an executable script file
function reccmd {
    FILE=${1:?'Usage reccmd <cmdname>'}
    [ -e $FILE ] && echo "Command already exists: $FILE" && return 1
    tee "$FILE" | (bash && chmod +x "$FILE")
}

# PYTHON
alias pip=pip3
alias python=python3
alias tb="tensorboard"
alias tl="tensorboard --logdir *logs*"
function jn { jupyter notebook --port ${1:-${PORT:-8888}}; }
alias jl="jupyter notebook list"
alias ipy=ipython
alias py=python
alias m3="python3 -m"
alias m="m3"

# Virtual Env / venv
function venv { python -m venv ${1:-venv} && vactivate; }
function vactivate { source ${1:-*}/bin/activate; }
alias ve=venv
alias va=vactivate
alias vd=deactivate

# NOTES
export NOTES_FILE="$HOME/notes.txt"
function note() { echo "$@" >> $NOTES_FILE; }
alias n=note
alias notes="cat $NOTES_FILE"
alias clrnotes="rm $NOTES_FILE"

# MASTERARBEIT CLUSTER LME
alias cluster="ssh $CLUSTER"
function lme() {
    if [ -z "$1" ]; then
        ssh $LME
    else
        local cmd="export PORT=$1; bash -l"
        ssh -tL $1:localhost:$1 "${2:-$LME}" "$cmd"
    fi
}
function lme-tb() {
    if [ -z "$1" ]; then
        echo "err: Missing port" >&2
        return 1
    fi
    ssh -tL $1:localhost:$1 "${2:-$LME}" "cd source/grad-cam && tensorboard --logdir *logs* --port $1"
}

# Secrets
function encrypt {
    [ -z "$1" ] && echo "usage: encrypt <outfile>" && return 1
    [ -e "$1" ] && echo "err: File $1 already exists." && return 1
    secret=$(openssl aes-256-cbc -e -a -salt -pbkdf2 -iter 100000)
    echo "#!/bin/sh" >> "$1"
    echo "echo \"$secret\" | openssl aes-256-cbc -d -a -salt -pbkdf2 -iter 100000 \$@" >> "$1"
    chmod +x "$1"
}

# Source machine local aliases
if [ -f $HOME/.local/bash_aliases ]; then
    . $HOME/.local/bash_aliases
fi

# Used to chain to long commands. Makes bell sound.
alias bell="tput bel"
